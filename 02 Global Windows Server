ðŸ“… 01.10.2022 ðŸ•˜ [09:00]

Global Windows Server

WykÅ‚adowca: BogusÅ‚aw Grunwald
@: boguslaw.grunwald@hackeru.com

Chapter 1 Creating an Organization & Active Directory Management
= - = - = - = - = - = - =  - = - = - = - = - = - = - = - = - = -

â„¹ï¸ Przerwy: 

10:30 - 11:00
12:30 - 13:15
15:00 - 15:15

ðŸ”— -- Download Windows Machines

- https://software-download.microsoft.com/download/pr/Windows_Server_2016_Datacenter_EVAL_en-us_14393_refresh.ISO
- https://www.microsoft.com/pl-pl/windows-server/windows-admin-center
- https://www.microsoft.com/en-US/download/details.aspx?id=45520

---

Sprawdzenie wersji Windows:

    winver

WÅ‚aÅ›ciwoÅ›ci systemu Windows:
    
    sysdm.cpl

---

ðŸ”— -- Microsoft Download
https://www.microsoft.com/en-us/software-download/

ðŸ”— -- Baza obrazÃ³w ISO (PL)
https://winiso.pl/

ðŸ”— -- Dokumentacja Microsoft

https://docs.microsoft.com/en-us/windows-server/identity/ad-ds/active-directory-domain-services
https://docs.microsoft.com/pl-pl/windows-server/get-started-19/get-started-19
https://docs.microsoft.com/en-us/windows-server/identity/ad-ds/plan/using-the-organizational-domain-forest-model
https://docs.microsoft.com/en-us/windows-server/identity/ad-ds/active-directory-functional-levels
https://docs.microsoft.com/en-us/deployoffice/vlactivation/configure-a-kms-host-computer-for-office

ðŸ”— -- Dodatkowe
https://www.thomas-krenn.com/pl/wiki/Kategoria:Windows
https://pl.wikipedia.org/wiki/Zmienna_Å›rodowiskowa
https://nsix.pl/kb/tworzenie-kopii-zapasowej-w-systemie-windows-server/
https://pl.if-koubou.com/articles/how-to/what-windows-10s-optional-features-do-and-how-to-turn-them-on-or-off.html

ðŸ”— -- Procesy w windows
https://testerzy.pl/artykuly/procesy-w-windows

ðŸ”— -- Dokumentacja Vbox
https://www.virtualbox.org/wiki/Technical_documentation
https://www.virtualbox.org/manual/ch06.html
--

Konfiguracja w VirtualBox dla Windows Server 2016:
    

        4 GB RAM (4096)

        1x lub 2x CPU

        50 GB SSD

        wersja GUI

        Interface sieciowy: Adapter 1: Internal Network (SieÄ‡ wewnÄ™trzna)

        Memory: Dysk z obrazem Windows_2016[...].iso

        System: kolejnoÅ›Ä‡ boot'owania - 1. NapÄ™d optyczny | 2. HDD

    
Windows Setup - wersja Windows
    Windows Server Standard Evaluation (Desktop Exp.)
    

### ðŸ’¡ -- Dodawanie Guest Additions do Wirtualnej Maszyny

ZakÅ‚adka w VB: UrzÄ…dzenia (Devices) -- > Zamontuj obraz pÅ‚yty z dodatkami goÅ›cia (Insert Guest Additions CD Image). 

Wchodzimy do Komputera (explorator plikÃ³w - gÅ‚Ã³wny katalog systemu) --> wchodzimy Prawym przyciskim myszy (Dysk CD) --> otwÃ³rz (aby wyÅ›wietliÄ‡ pliki) --> odpalamy VNoxWindowsAdditions-amd64.exe 

Restartujemy maszynÄ™

--- 

### ðŸ“‹ -- Lab01 Windows Server Installation

Adresacja serwerÃ³w:
    
10.0.0.0/24

Win_10:                IP - 10.0.0.3 | Subnet mask - 255.255.255.0 | DNS - 10.0.0.1
Win_Server_2016_DC01:  IP - 10.0.0.1 | Subnet mask - 255.255.255.0 | DNS - 10.0.0.1
Win_Server_2016_DC02:  IP - 10.0.0.2 | Subnet mask - 255.255.255.0 | DNS - 10.0.0.1

Wykonanie adresacji maszyn: Win+R ncpa.cpl

---

Windows 10:
    
    Interface sieciowy (VirtualBox): Internal Network

Zmiana nazwy na Windows 10:
    
   sysdm.cpl
    
Nazwa: PC01


    Restart


Zmiana adresacji sieciowej:
    
    ncpa.cpl

Win_10: 10.0.0.3 | Subnet mask - 255.255.255.0 | DNS - 10.0.0.1

---

Sprawdzenie komunikacji z W10 > W2016

    ping 10.0.0.1


Sprawdzenie komunikacji z W2016 > W10

WyÅ‚Ä…czenie firewall:

    Terminal jako Administrator:


    netsh advfirewall set allprofiles state off


    ping 10.0.0.3


---

DoÅ‚Ä…czanie W10 do domeny cyber.local

    sysdm.cpl


    Change > Member of Domain


    PoÅ›wiadczenia Administratora DC01


    Restart


Windows 10: Terminal

    net user          #konta lokalne


    net user /domain  #konta domenowe


Logowanie na `Other user`

    jkowalski | password: ******** | Sign in to: CYBER


ðŸ”— â€” List of Acitve Directory cmdlets
https://docs.microsoft.com/en-us/powershell/module/activedirectory/?view=windowsserver2022-ps

#Dodawanie nowych organization unit, w Active Directory Users and Computers:
   Cyber.local -> new -> Organizational Unit
np: IT, Serwis, Produkcja, Kierownictwo

#Aby przypisaÄ‡/ zaÅ‚oÅ¼yÄ‡ usera w grupie: klikamy na jednostkÄ™ - 
   klikamy prawym i New->User

#Aby przenieÅ›Ä‡ do grupy, klikamy na userze, prawym klawisem i Move i dalej wybraÄ‡ katalog

#wszelkie ustawienia konta sÄ… dostÄ™pne po klikniÄ™ciu na konto prawym klawiszem i Properties

#Aby przenosiÄ‡/ kopiowaÄ‡ polecenia i pliki miÄ™dzy hostem a maszynÄ… wirtualnÄ…
Devices-> Drag and Drop -> Bidirectional

#Start - Windows PowerShell

New-ADUser -Name "test4" -GivenName "test4" -SamAccountName "test4" -UserPrincipalName "test4@cyber.local" -Path "CN=Users,DC=cyber,DC=local"-AccountPassword (Read-Host "Enter password: " -AsSecureString) -Enabled $true

#zapisaÄ‡ to jako skrypt na serwerze -> konta.bat
@echo
dsadd user "CN=informatyk01,OU=IT,DC=cyber,DC=local" -samid informatyk01 -upn informatyk01@cyber.local -pwd P@$$w0rd -mustchpwd yes -canchpwd yes -disabled no
dsadd user "CN=informatyk02,OU=IT,DC=cyber,DC=local" -samid informatyk02 -upn informatyk02@cyber.local -pwd P@$$w0rd -mustchpwd yes -canchpwd yes -disabled no 
dsadd user "CN=informatyk03,OU=IT,DC=cyber,DC=local" -samid informatyk03 -upn informatyk03@cyber.local -pwd P@$$w0rd -mustchpwd yes -canchpwd yes -disabled no 
dsadd user "CN=informatyk04,OU=IT,DC=cyber,DC=local" -samid informatyk04 -upn informatyk04@cyber.local -pwd P@$$w0rd -mustchpwd yes -canchpwd yes -disabled no 
dsadd user "CN=informatyk05,OU=IT,DC=cyber,DC=local" -samid informatyk05 -upn informatyk05@cyber.local -pwd P@$$w0rd -mustchpwd yes -canchpwd yes -disabled no  
pause
    
   Tworzenie grupy:
dsadd group "CN=Serwis,CN=Users,DC=cyber,DC=local" -secgrp yes -scope g


Dodawanie uÅ¼ytkownikÃ³w do grupy:
dsmod group "CN=Serwis,CN=Users,DC=cyber,DC=local" -addmbr "CN=test3,CN=Users,DC=cyber,DC=local"


### ðŸ“‹ -- Lab03 AD User & Group Management

ustawiamy godziny logowania w template -> prawym klawiszem na template i Account-> logon Hours i wybieramy zakres godzin/ godziny

#Mapowanie katalogu jako katalog domowy userowi z posiomu domeny:

    tworzymy folder na serwerze c:\home

    naleÅ¼y udostÄ™pniÄ‡ go w sieci -> uprawnienia dla wszystkich 

    w ustawieniach konta w AD wÅ‚asciwoÅ›ci usera -> profile w "home folder" zaznaczyÄ‡ connect, wybrac literkÄ™ np. O i \\DC01\home\%username%

    profil migrujÄ…cy - dodaÄ‡ link do folderu na serwerze do Profile path



MMC - Microsoft Management Console - tam dodajemy przystawki (tworzymy zbÃ³r narzÄ™dzi najczÄ™Å›ciej uÅ¼ywanych)


REG  ADD HKLM\Software\Microsoft\Windows\CurrentVersion\Policies\System\CredSSP\Parameters\ /v AllowEncryptionOracle /t REG_DWORD /d 2

Tworzymy nowÄ… maszynÄ™ typu Windows2016 - DC02 (tak samo jak poprzedniÄ…)
Win_Server_2016_DC02:  IP - 10.0.0.2 | Subnet mask - 255.255.255.0 | DNS - 10.0.0.1
Na tej maszynie skonfigurujemy server DHCP.  


=======================================================================================

ðŸ“… 02.10.2022 ðŸ•˜ [09:00]

Global Windows Server

WykÅ‚adowca: BogusÅ‚aw Grunwald
@: boguslaw.grunwald@hackeru.com

Chapter 2: Working with Services & GPO Management
= - = - = - = - = - = - =  - = - = - = - = - = - 

â„¹ï¸ Przerwy: 

10:30 - 11:00
12:30 - 13:15
15:00 - 15:15


### ðŸ“‹ -- Lab04 Server Manager & Login Process

Z poziomu DO01 wybieramy Add other server to manage i dodajemy DC02 (find now).
Z poziomu D001 instalujemy nowÄ… rolÄ™ DHCP Server na serwerze DC02.
Complete DHCP configuration - koÅ„czymy proces instalacji DHCP.
Sprawdzamy na DC02 czy dhcp siÄ™ zainstalowaÅ‚o.

z Poziomu DC01 prawym klawiszem na serwer DC02 i wybieramy PowerShell i wpisujemy komendÄ™:
   Restart-Computer -ComputerName DC02



Replikcja bazy danych AD na DC02:
dodajemy nowÄ… rolÄ™ na DC02 (z poziomu DC01, Server Manager Dashboard) -> Active Directory Domain Services (reszta opcji domyÅ›lnie). 
W kolejnym kroku klikamy Promote-> Add a domain controller to an exisiting domain. 
Uwaga! naleÅ¼y zmieniÄ‡ konto (change) na administratora domeny (Administrator z DC01):
   CYBER\Administrator
Instalujemy Domain Name System (DNS) sever i Global Catalog (GC) + hasÅ‚o do odzyskiwania bazy danych.
Wybieramy skÄ…d chcemy replikowaÄ‡ -> DC01
Reszta opcji domyÅ›lnie.

Aby wÅ‚Ä…czyÄ‡ kosz w AD naleÅ¼y wejÅ›Ä‡ w Tools->Active Directory Administrative Center
nastepnie rozwinÄ…Ä‡ cyber (local) i po prawej stronie (task) wÅ‚Ä…czyÄ‡ kosz.
Aby usunÄ…Ä‡ konta z kosza naleÅ¼y wpisaÄ‡ komendÄ™ w PowerShell:

Get-ADObject -Filter {isDeleted -eq $True -and Name -like '*informatyk04*'} -IncludeDeletedObjects| Remove-ADObject


===========================

lokalizacja pliku hosts
C:\Windows\System32\drivers\â€‹etc\hosts

ipconfig
ipconfig /displaydns  - #podrÄ™czny cache dns-a
ipconfig /flushdns  -#czyszczenie podrÄ™cznego cache

nslookup
nslookup -type=ns
nslookup -type=mx onet.pl
nslookup -type=A onet.pl

ðŸ”— â€” DHCP
https://pl.wikipedia.org/wiki/Dynamic_Host_Configuration_Protocol

ðŸ”— â€” DNS record types
https://en.wikipedia.org/wiki/List_of_DNS_record_types
https://root-servers.org/

ðŸ”— â€” DNS checks
https://www.ionos.com/digitalguide/server/tools/nslookup/

### ðŸ“‹ -- Lab02 DNS Installation & Configuration

Otwieramy: Tools->DNS
rozwijamy: rozwijamy DNS i DC01 dalej: Forward Lookup zone, prawym klawiszem i new zone  (testowa)
wybieramy primary, next

#teraz musimy dodaÄ‡ wpis A
right click
new host a or aaa
w name wpisujemy nazwÄ™
np.: hackeru
( FQDN samo siÄ™ edytuje )
ustalamy powiÄ…zany adres IP - np 172.20.10.10
add host

#sprawdzamy na stacji windows10
  nslookup hackeru.testowa
  nslookup 172.20.10.10 - nie dziaÅ‚a bo musimy stworzyÄ‡ rekord ptr

#II sposÃ³b (z reverse)
right click na forward lookup zones, new zone
wybieramy primary
next
replication scope
to all dns servers running in domain
next
zone name:
podajemy nazwÄ™ domeny- id sieci 10.0.0
next
dynamic update
default - allow only secure dynamic updates (recomm. for AD )
next
finish
z prawej strony widzimy utwowrzonÄ… strefÄ™.

#teraz musimy dodaÄ‡ wpis A
right click
new host a or aaa
w name wpisujemy nazwÄ™
np.:  hackeru 
( FQDN samo siÄ™ edytuje )
ustalamy powiÄ…zany adres IP - np 10.0.0.5
zaznaczamy create PTR record
add host

#sprawdzamy na stacji windows10
  nslookup hackeru
  nslookup 10.0.0.5

#Serwer DHCP (na DC01)
dodajemy nowÄ… rolÄ™ na DC01 -> DHCP Server
#Konfiguracja servera DHCP
Tools
DHCP

#Konfiguracja servera DHCP
Tools
DHCP
Rozwijamy server DC01.Cyber.local
Prawym klawiszem na IPv4
new scope (uruchomi siÄ™ kreator)
nazwa: Pula_10.0.0.0
Range:
   Start IP address : 10.0.0.1
   End IP address: 10.0.0.253
    
   Lenght: 24
   next
Add exclusions and Delay:
   10.0.0.1 â€“ 10.0.0.10 i Add
Limited to:  
   8 days
Dodatkowe opcje:
   Router â€“ 10.0.0.254 + Add
Domain Name and DNS Servers:
    Cyber.local -10.0.0.1
    DC02 -10.0.0.2
Wins Servers â€“ puste
Aktywujemy new scope. 
Next 
Finish

#Sprawdzamy na Windows10
  w ustawieniach karty sieciowej wybieramy w ip4 (wÅ‚aÅ›ciwoÅ›ci) DHCP - czyli automatyczne pobieranie adresu IP i dns
  cmd
  ipconfig /all - widzimy nasz dhcp, nowy adres i serverDNS

#Konfiguracja rezerwacji DHCP

    Kopiujemy MAC-Address z WIN10. Po stronie servera z termiala: arp -a

    DHCP > Nowa rezerwacja PC01 | IP 10.0.0.150 | MAC-Address

    Windows 10 > Terminal

    ipconfig /release #zwalnia adres IP i przekazuje go do puli na serwerze

    ipconfig /renew #pobiera nowy adres z serwera


#Zablokowanie PC01 w celu odmowy przydzielenia IP

    WinServer2016: DHCP > Filters > Deny > New Filter

    Prawy klawisz myszy na Deny > Enable

    Weryfikacja po stronie klienta W10

    ipconfig /release

    ipconfig /renew

    ipconfig

    klient nie otrzymuje adresu IP


### ðŸ“‹ -- Lab01 DHCP Installation & Configuration

Konfiguracja w trybie Failover

    DC01 > UsunÄ…Ä‡ wszystkie filtry z DHCP oraz rezerwacjÄ™

    DHCP (prawy klawisz myszy) Add Server > DC02

    Replikujemy na DC02 bazÄ™ DHCP

    DC01 > IPv4 (prawy klawisz myszy) > Configure Failover

    Partner Server > Add Server > DC02

    Mode: Load balance | Shared Secret: ********

    Finish

    DC01 > IPv4 (prawy klawisz myszy) > Replicate Failover Scopes


#ZakÅ‚Ã³cenie pracy serwera (DHCP starvation attack)

ðŸ”— -- What is a DHCP Starvation Attack?
https://www.cbtnuggets.com/blog/technology/networking/what-is-a-dhcp-starvation-attack

Kali > Interface: NAT

    sudo apt update

    sudo apt install yersinia


Zmiana interface'u sieciowego na: Internal Network.

Win10: 

    ipconfig /release


Kali:

    sudo yersinia -G


    DHCP > Launch Attack > sending DISCOVER packet

    Win10 : ipconfig /renew

    Serwer wydaÅ‚ wszystkie adresy IP z puli - maszyna wyscyca zasoby sprzÄ™towe

    Zatrzymanie ataku: Lists attacks > Stop

    W celu przywrÃ³cenia stabilnoÅ›ci Å›rodowiska naleÅ¼y zrestarowaÄ‡ wszystkie maszyny


ðŸ”— -- Understanding and Preventing DHCP Starvation Attacks
https://ritcsec.wordpress.com/2022/05/06/understanding-and-preventing-dhcp-starvation-attacks/


---

GPO (Group Policy Objects)

Terminal > Run as Admin

    gpedit.msc

    gpmc.msc


Group Policy Management

Domains > cyber.local > Default Domain Policy

Wprowadzenie utworzonych polityk GPO

    gpupdate /force


ðŸ”— -- KolejnoÅ›Ä‡ przetwarzania i wdraÅ¼ania zasad GPO
https://pasja-informatyki.pl/sieci-komputerowe/zasady-grup-kolejnosc-zasad/

***

### ðŸ’¡ -- Extra Miles

    Ustaw opcje dotyczÄ…cÄ… zÅ‚oÅ¼onoÅ›ci hasÅ‚a

    Ustaw minimalnÄ… dÅ‚ugoÅ›Ä‡ hasÅ‚a na 8 znakÃ³w

    Ustaw iloÅ›Ä‡ pamiÄ™tanych haseÅ‚ na 10

    ZmieÅ„ max okres waÅ¼noÅ›ci hasÅ‚a na 180 dni

    Ustaw prÃ³g blokady konta na 3 nieudane prÃ³by logowania

    Ustaw opcjÄ™ monitorowania zmiany hasÅ‚a 7 dni przed jego wygaÅ›niÄ™ciem.

    Ustaw tytuÅ‚ komunikatu powitalnego dla uÅ¼ytkownikÃ³w na nastÄ™pujÄ…cy:

    "SYSTEM TELEINFORMATYCZNY HackerU"

8. Ustaw tekst komunikatu dla uÅ¼ytkownikÃ³w prÃ³bujÄ…cych siÄ™ zalogowaÄ‡ na nastÄ™pujÄ…cy:

    "Witamy na szkoleniu z Windows Server 2016"

9. ZabroÅ„ dostÄ™pu do Rejestru dla wszystkich uÅ¼ytkownikÃ³w.

WinServer2016:

    Dysk c:\

    UtworzyÄ‡ katalogi \Dane \Kopie \Programy

    UdostÄ™pniamy te katalogi z opcjÄ… `Full Control`

    Linki wklejamy do Nowego pliku wykonywalnego na Pulpicie dyski.bat (Save as | All files)


    net use x: \\10.0.0.1\Dane

    net use y: \\10.0.0.1\Kopie

    net use z: \\10.0.0.1\Programy


    Kopiujemy plik Ctrl+C

    Domains > cyber.local > Default Domain Policy > User Configuration > Polices > Windows Settings > Scripts (Logon/Logoff) : (prawy klawisz myszy) Properties

    Showfiles > Paste

    Add > Browse > dyski.bat

    Apply > OK


Windows 10:

    gpupdate /force

    ponowne logowanie uÅ¼ytkownika

    dyski zostaÅ‚y podmontowane w widoku `This PC`



### -- ðŸ’¡ Instalacja nowego oprogramowania

https://www.mozilla.org/pl/firefox/all/#product-desktop-release

    Wybieramy Windows 64-bit MSI > Pobierz teraz

    Kopiujemy plik na Server DC01 (Firefox Setup 105.0.1.msi)

    Umieszczamy w nowym katalogu c:\msi\

    UdostÄ™pniamy katalog c:\msi\ > Advanced Sharing > Read

    Domains > cyber.local > Default Domain Policy > User Configuration > Polices > Software Settings > Software Installation (prawy klawisz myszy) New > Package

    Podajemy Å›ciezkÄ™ dostÄ™pu do instalatora //DC01/msi/Firefox Setup 105.0.1.msi

    Po chwili pokazuje siÄ™ zmiana w GPO

    Mozilla Firefox 105.0.1 x64 pl (prawy klawisz myszy) > Properties > Deployment > Install this application at logon

    Security > Authenticated Users > Allow Full Control

    Ustawienie wiÄ™kszej szczegÃ³Å‚owoÅ›ci pokazywanych komunikatÃ³w Domains > cyber.local > Default Domain Policy > User Configuration > Polices > Administrative Templates Policy definitions > System > Dispaly highly detailed status messages > Enable

    Zastosowanie nowych polityk gpupdate /force

    Przy nowym zalogowaniu pojawia siÄ™ komunikat: "Installing managed software Mozilla Firefox 105.0.1 x64 pl..."


***

